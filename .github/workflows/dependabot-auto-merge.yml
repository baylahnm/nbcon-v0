name: Dependabot Auto-Merge

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    
    steps:
      - name: Check if PR is safe to auto-merge
        id: check
        run: |
          # Only auto-merge patch and minor updates
          # Major updates require manual review
          PR_TITLE="${{ github.event.pull_request.title }}"
          
          # Check if it's a patch update (0.0.x)
          if echo "$PR_TITLE" | grep -qE "bump.*from.*to.*\.[0-9]+\.[0-9]+"; then
            echo "safe=true" >> $GITHUB_OUTPUT
            echo "✅ Patch update detected - safe to auto-merge"
            exit 0
          fi
          
          # Check if it's a minor update (0.x.0)
          if echo "$PR_TITLE" | grep -qE "bump.*from.*\.[0-9]+\.[0-9]+.*to.*\.[0-9]+\.[0-9]+"; then
            # Extract version numbers
            FROM_VERSION=$(echo "$PR_TITLE" | grep -oE "from [0-9]+\.[0-9]+\.[0-9]+" | cut -d' ' -f2)
            TO_VERSION=$(echo "$PR_TITLE" | grep -oE "to [0-9]+\.[0-9]+\.[0-9]+" | cut -d' ' -f2)
            
            FROM_MAJOR=$(echo "$FROM_VERSION" | cut -d'.' -f1)
            TO_MAJOR=$(echo "$TO_VERSION" | cut -d'.' -f1)
            
            if [ "$FROM_MAJOR" = "$TO_MAJOR" ]; then
              echo "safe=true" >> $GITHUB_OUTPUT
              echo "✅ Minor update detected - safe to auto-merge"
              exit 0
            fi
          fi
          
          echo "safe=false" >> $GITHUB_OUTPUT
          echo "⚠️ Major update detected - requires manual review"
          exit 0

      - name: Wait for checks to pass
        if: steps.check.outputs.safe == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const maxWait = 300; // 5 minutes
            const checkInterval = 10; // 10 seconds
            let waited = 0;
            
            while (waited < maxWait) {
              const { data: checks } = await github.rest.checks.listForRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: context.payload.pull_request.head.sha,
              });
              
              const allPassed = checks.check_runs.every(
                check => check.status === 'completed' && check.conclusion === 'success'
              );
              
              if (allPassed) {
                console.log('✅ All checks passed!');
                return;
              }
              
              await new Promise(resolve => setTimeout(resolve, checkInterval * 1000));
              waited += checkInterval;
            }
            
            throw new Error('Timeout waiting for checks to pass');

      - name: Auto-merge PR
        if: steps.check.outputs.safe == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              merge_method: 'squash',
            });
            console.log('✅ PR auto-merged successfully!');

