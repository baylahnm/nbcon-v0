name: Dependabot Auto-Merge

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    
    steps:
      - name: Check if PR is safe to auto-merge
        id: check
        run: |
          # Auto-merge policy: Only patch updates (security fixes)
          # Minor and major updates require manual review
          PR_TITLE="${{ github.event.pull_request.title }}"
          
          # Extract version numbers from PR title
          # Dependabot format: "Bump {package} from X.Y.Z to A.B.C"
          FROM_VERSION=$(echo "$PR_TITLE" | grep -oE "from [0-9]+\.[0-9]+\.[0-9]+" | cut -d' ' -f2)
          TO_VERSION=$(echo "$PR_TITLE" | grep -oE "to [0-9]+\.[0-9]+\.[0-9]+" | cut -d' ' -f2)
          
          if [ -z "$FROM_VERSION" ] || [ -z "$TO_VERSION" ]; then
            echo "safe=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Could not parse version numbers - requires manual review"
            exit 0
          fi
          
          # Parse semantic version components (MAJOR.MINOR.PATCH)
          FROM_MAJOR=$(echo "$FROM_VERSION" | cut -d'.' -f1)
          FROM_MINOR=$(echo "$FROM_VERSION" | cut -d'.' -f2)
          FROM_PATCH=$(echo "$FROM_VERSION" | cut -d'.' -f3)
          
          TO_MAJOR=$(echo "$TO_VERSION" | cut -d'.' -f1)
          TO_MINOR=$(echo "$TO_VERSION" | cut -d'.' -f2)
          TO_PATCH=$(echo "$TO_VERSION" | cut -d'.' -f3)
          
          # Check if it's a patch update (0.0.x) - only MAJOR and MINOR stay the same
          if [ "$FROM_MAJOR" = "$TO_MAJOR" ] && [ "$FROM_MINOR" = "$TO_MINOR" ] && [ "$FROM_PATCH" != "$TO_PATCH" ]; then
            echo "safe=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Patch update detected ($FROM_VERSION ‚Üí $TO_VERSION) - safe to auto-merge"
            exit 0
          fi
          
          # Check if it's a minor update (0.x.0) - requires manual review
          if [ "$FROM_MAJOR" = "$TO_MAJOR" ] && [ "$FROM_MINOR" != "$TO_MINOR" ]; then
            echo "safe=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Minor update detected ($FROM_VERSION ‚Üí $TO_VERSION) - requires manual review"
            exit 0
          fi
          
          # Check if it's a major update (x.0.0) - requires manual review
          if [ "$FROM_MAJOR" != "$TO_MAJOR" ]; then
            echo "safe=false" >> $GITHUB_OUTPUT
            echo "üõë Major update detected ($FROM_VERSION ‚Üí $TO_VERSION) - requires manual review"
            exit 0
          fi
          
          # Fallback: unknown version change pattern
          echo "safe=false" >> $GITHUB_OUTPUT
          echo "‚ö†Ô∏è Unknown version change pattern ($FROM_VERSION ‚Üí $TO_VERSION) - requires manual review"
          exit 0

      - name: Wait for checks to pass
        if: steps.check.outputs.safe == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const maxWait = 300; // 5 minutes
            const checkInterval = 10; // 10 seconds
            let waited = 0;
            
            while (waited < maxWait) {
              const { data: checks } = await github.rest.checks.listForRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: context.payload.pull_request.head.sha,
              });
              
              const allPassed = checks.check_runs.every(
                check => check.status === 'completed' && check.conclusion === 'success'
              );
              
              if (allPassed) {
                console.log('‚úÖ All checks passed!');
                return;
              }
              
              await new Promise(resolve => setTimeout(resolve, checkInterval * 1000));
              waited += checkInterval;
            }
            
            throw new Error('Timeout waiting for checks to pass');

      - name: Auto-merge PR
        if: steps.check.outputs.safe == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              merge_method: 'squash',
            });
            console.log('‚úÖ PR auto-merged successfully!');

