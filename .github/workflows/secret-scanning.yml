name: Secret Scanning

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

# Security: Minimal permissions for scanning
permissions:
  contents: read
  security-events: write

jobs:
  scan-secrets:
    runs-on: ubuntu-latest
    name: Scan for exposed secrets
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Full history for better detection

      - name: Run TruffleHog Secret Scanning
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --only-verified

      - name: Run Gitleaks Secret Scanning
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          config-path: .gitleaks.toml
          no-banner: true
          redact: true

      - name: Check for common secret patterns
        run: |
          echo "Scanning for common secret patterns..."
          PATTERNS=(
            "api[_-]?key\s*[:=]\s*['\"][^'\"]{20,}"
            "secret[_-]?key\s*[:=]\s*['\"][^'\"]{20,}"
            # Make password checks stricter — require longer strings and exclude error messages
            "password\s*[:=]\s*['\"][^'\"]{12,}"
            "token\s*[:=]\s*['\"][^'\"]{20,}"
            "private[_-]?key\s*[:=]\s*['\"][^'\"]{20,}"
          )
          
          FOUND_SECRETS=false
          for pattern in "${PATTERNS[@]}"; do
            # exclude known safe directories (translations, build dirs, etc.)
            # also exclude error messages and validation messages
            if grep -r -E "$pattern" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" \
                 --exclude-dir=node_modules --exclude-dir=.next --exclude-dir=dist --exclude-dir=apps/web/src/lib/i18n \
                 | grep -v "process.env\|import.meta.env\|Deno.env\|window.__ENV__\|Password is required\|Password must be\|Passwords do not match\|Forgot Password\|Confirm Password\|errors\.password\|newErrors\.password" >/dev/null 2>&1; then
              echo "⚠️ Potential secret found matching pattern: $pattern"
              FOUND_SECRETS=true
            fi
          done
          
          if [ "$FOUND_SECRETS" = true ]; then
            echo "❌ Potential secrets detected. Please review and remove hardcoded credentials."
            exit 1
          else
            echo "✅ No hardcoded secrets detected."
          fi

