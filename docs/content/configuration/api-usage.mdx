---
title: API Usage
section: configuration
---

# API Usage Guide

This guide covers how to use NBCON PRO's APIs, including AI agent endpoints, Supabase integration, and authentication.

## Overview

NBCON PRO provides several APIs:

- **AI Agent API** - `/api/ai/run` - Execute AI agent requests
- **Stripe API** - Edge Functions for checkout and webhooks
- **Supabase API** - Direct database and auth access
- **Enterprise SDK** - REST/GraphQL client for integrations

---

## AI Agent API

### Endpoint

```
POST /api/ai/run
```

### Request Format

```typescript
{
  model: string;           // AI model identifier (e.g., "gpt-4")
  messages: Array<{        // Conversation messages
    role: "system" | "user";
    content: string;
  }>;
  temperature?: number;    // 0-1, default: 0.3
  max_tokens?: number;     // Default: 4000
}
```

### Example Request

```typescript
const response = await fetch("/api/ai/run", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    model: "gpt-4",
    messages: [
      {
        role: "system",
        content: "You are a geotechnical engineering specialist."
      },
      {
        role: "user",
        content: "Analyze this soil sample data..."
      }
    ],
    temperature: 0.3,
    max_tokens: 4000
  })
});

const data = await response.json();
// { output: string, tokens: number }
```

### Response Format

```typescript
{
  output: string;         // AI-generated response
  tokens: number;         // Token usage count
}
```

### Error Handling

```typescript
if (!response.ok) {
  const error = await response.json();
  // { error: string }
}
```

### Using the Hook

```typescript
import { useAIAgent } from "@/features/ai/hooks/useAIAgent";

function MyComponent() {
  const { runAgent, loading, error } = useAIAgent("geotechnical");
  
  const handleRun = async () => {
    const result = await runAgent({
      prompt: "Analyze soil properties...",
      options: {
        temperature: 0.5,
        maxTokens: 2000
      }
    });
    console.log(result.output);
  };
}
```

---

## Supabase API

### Authentication

```typescript
import { supabase } from "@nbcon/config";

// Sign up
const { data, error } = await supabase.auth.signUp({
  email: "user@example.com",
  password: "password123"
});

// Sign in
const { data, error } = await supabase.auth.signInWithPassword({
  email: "user@example.com",
  password: "password123"
});

// Get current user
const { data: { user } } = await supabase.auth.getUser();
```

### Database Queries

```typescript
// Select
const { data, error } = await supabase
  .from("profiles")
  .select("id, subscription_tier")
  .eq("id", userId)
  .single();

// Insert
const { data, error } = await supabase
  .from("ai_logs")
  .insert({
    user_id: userId,
    agent: "geotechnical",
    input: "Analyze soil...",
    output: "Results...",
    tokens_used: 150
  });

// Update
const { error } = await supabase
  .from("profiles")
  .update({ subscription_tier: "pro" })
  .eq("id", userId);
```

### Realtime Subscriptions

```typescript
// Subscribe to tier changes
const channel = supabase
  .channel("tier_changes")
  .on(
    "postgres_changes",
    {
      event: "*",
      schema: "public",
      table: "profiles",
      filter: `id=eq.${userId}`
    },
    (payload) => {
      console.log("Tier updated:", payload.new.subscription_tier);
    }
  )
  .subscribe();

// Cleanup
supabase.removeChannel(channel);
```

---

## Stripe API

### Create Checkout Session

```typescript
// Call Edge Function
const response = await fetch(
  "https://your-project.supabase.co/functions/v1/stripe-checkout",
  {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${supabaseAnonKey}`
    },
    body: JSON.stringify({
      priceId: "price_xxx",
      userId: "user-uuid"
    })
  }
);

const { url } = await response.json();
window.location.href = url; // Redirect to Stripe Checkout
```

### Webhook Events

Stripe webhooks are handled automatically by the `stripe-webhook` Edge Function. Events processed:

- `checkout.session.completed` - Updates subscription tier
- `customer.subscription.updated` - Updates subscription tier
- `customer.subscription.deleted` - Resets to free tier

---

## Enterprise SDK

### API Client

```typescript
import { fetchData } from "@nbcon/enterprise-sdk";

// Fetch data
const logs = await fetchData<AuditLog>("audit_logs");
const profiles = await fetchData<Profile>("profiles");
```

### Telemetry

```typescript
import { track } from "@nbcon/enterprise-sdk/telemetry";

// Track events
track("ai_agent_request", {
  agent_id: "geotechnical",
  tokens_used: 150,
  user_id: userId
});

track("tier_upgraded", {
  oldTier: "free",
  newTier: "pro",
  userId: userId
});
```

---

## Agent Registry

### Available Agents

```typescript
import { agentRegistry } from "@nbcon/ai-core";

// List all agents
Object.keys(agentRegistry); 
// ["geotechnical", "environmental", ...]

// Get agent config
const agent = agentRegistry["geotechnical"];
// {
//   id: "geotechnical",
//   context: "Geotechnical Engineering",
//   description: "...",
//   model: "gpt-4",
//   temperature: 0.3,
//   maxTokens: 4000
// }
```

---

## Validation Schemas

### Zod Schemas

```typescript
import { AIRequestSchema, AgentRequestSchema } from "@nbcon/ai-core";

// Validate AI request
const result = AIRequestSchema.safeParse(requestBody);
if (!result.success) {
  console.error(result.error);
}

// Validate agent request
const agentResult = AgentRequestSchema.safeParse(agentBody);
```

---

## Error Handling

### Common Errors

```typescript
// API Errors
if (!response.ok) {
  const error = await response.json();
  // Handle: { error: "message" }
}

// Supabase Errors
if (error) {
  console.error("Supabase error:", error.message);
  // Handle based on error.code
}

// Network Errors
try {
  await fetch("/api/ai/run", ...);
} catch (err) {
  if (err instanceof TypeError) {
    // Network error
  }
}
```

---

## Rate Limiting

Currently, rate limiting is handled by:
- OpenAI API limits (based on your plan)
- Supabase rate limits (RLS policies)
- Stripe rate limits (API key tier)

---

## Best Practices

1. **Always validate input** using Zod schemas
2. **Handle errors gracefully** with user-friendly messages
3. **Use Realtime subscriptions** for live data updates
4. **Track usage** with PostHog telemetry
5. **Log errors** to Supabase for debugging
6. **Use TypeScript** for type safety

---

## See Also

- [Deployment Guide](./deployment.mdx)
- [API Reference](/docs/api/API_REFERENCE.md)
- [Agent Playbooks](/docs/agents/5-AGENT_PLAYBOOKS.md)

