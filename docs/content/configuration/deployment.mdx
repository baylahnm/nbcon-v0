---
title: Deployment Guide
section: configuration
---

# Deployment Guide

Complete guide for deploying NBCON PRO to production, including environment setup, Supabase configuration, Stripe integration, and CI/CD.

## Overview

NBCON PRO is deployed using:
- **Frontend:** Cloudflare Pages (Next.js)
- **Backend:** Supabase (Database, Auth, Edge Functions)
- **CDN:** Cloudflare
- **CI/CD:** GitHub Actions

---

## Prerequisites

- Node.js 20+
- pnpm 9+
- Supabase CLI
- Cloudflare account
- Stripe account
- GitHub repository

---

## Environment Setup

### 1. Clone Repository

```bash
git clone <repository-url>
cd nbcon_v0
pnpm install
```

### 2. Create `.env.local`

Copy `.env.example` to `.env.local` and fill in:

```bash
# Supabase
VITE_SUPABASE_URL=https://your-project.supabase.co
VITE_SUPABASE_ANON_KEY=your_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key

# Stripe
VITE_STRIPE_PUBLIC_KEY=pk_live_...
STRIPE_SECRET_KEY=sk_live_...
STRIPE_WEBHOOK_SECRET=whsec_...

# OpenAI
OPENAI_API_KEY=sk-...

# Analytics (Optional)
POSTHOG_KEY=phc_...
SENTRY_DSN=https://...

# Deployment
BASE_URL=https://your-domain.com
NODE_ENV=production
```

### 3. Supabase Setup

```bash
# Link to your Supabase project
supabase link --project-ref your-project-ref

# Run migrations
pnpm run migrate

# Deploy Edge Functions
supabase functions deploy stripe-checkout
supabase functions deploy stripe-webhook
supabase functions deploy lifecycle-cron
```

### 4. Configure Supabase Edge Functions

Set environment variables in Supabase Dashboard:

```bash
STRIPE_SECRET_KEY=sk_live_...
STRIPE_WEBHOOK_SECRET=whsec_...
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key
FRONTEND_URL=https://your-domain.com
```

---

## Database Migrations

### Apply Migrations

```bash
# Check migration status
supabase db diff

# Apply pending migrations
supabase db push

# Or use Supabase MCP
```

### Key Migrations

1. `20251102000001_add_subscription_columns.sql` - Subscription tiers
2. `20251102000004_create_ai_logs.sql` - AI usage tracking
3. `20251102000005_create_audit_logs.sql` - Compliance audit
4. `20251102000006_create_profile_trigger.sql` - Auto-create profiles

---

## Stripe Configuration

### 1. Create Products

In Stripe Dashboard:
1. Create Products for each tier (Free, Basic, Pro, Enterprise)
2. Create Prices (monthly/annual)
3. Note the `price_id` values

### 2. Update Webhook Mapping

Update `supabase/functions/stripe-webhook/index.ts`:

```typescript
const tierMap: Record<string, string> = {
  "price_free": "free",
  "price_basic": "basic",
  "price_pro": "pro",
  "price_enterprise": "enterprise"
};
```

### 3. Configure Webhook

1. Go to Stripe Dashboard → Webhooks
2. Add endpoint: `https://your-project.supabase.co/functions/v1/stripe-webhook`
3. Select events:
   - `checkout.session.completed`
   - `customer.subscription.updated`
   - `customer.subscription.deleted`
4. Copy webhook secret to environment variables

---

## Cloudflare Pages Deployment

### 1. Connect Repository

1. Go to Cloudflare Dashboard → Pages
2. Connect GitHub repository
3. Select branch: `main`

### 2. Build Settings

```
Build command: pnpm --filter @nbcon/web build
Build output directory: apps/web/.next
Root directory: (leave empty)
Node version: 20
```

### 3. Environment Variables

Add all production environment variables in Cloudflare Pages:
- `VITE_SUPABASE_URL`
- `VITE_SUPABASE_ANON_KEY`
- `VITE_STRIPE_PUBLIC_KEY`
- `POSTHOG_KEY` (optional)
- `SENTRY_DSN` (optional)

### 4. Custom Domain

1. Go to Pages → Custom Domain
2. Add your domain
3. Update DNS records as instructed

---

## CI/CD Pipeline

### GitHub Actions Workflows

The project includes three workflows:

#### 1. CI (`ci.yml`)

Runs on every push/PR:
- Lint
- Type check
- Unit tests (Vitest)
- E2E tests (Playwright)
- Coverage report
- Build

#### 2. Test (`test.yml`)

Runs on push to `main`/`develop`:
- Full test suite
- Coverage upload (Codecov)

#### 3. Deploy (`deploy.yml`)

Runs on push to `main`:
- Build application
- Deploy to Cloudflare Pages
- Deploy Supabase Edge Functions

### Secrets Required

Add to GitHub Secrets:

```
CLOUDFLARE_API_TOKEN
CLOUDFLARE_ACCOUNT_ID
SUPABASE_ACCESS_TOKEN
SUPABASE_DB_PASSWORD
CODECOV_TOKEN (optional)
```

---

## Post-Deployment Verification

### 1. Test Authentication

```bash
# Sign up
curl -X POST https://your-domain.com/api/auth/signup \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"test123"}'

# Sign in
curl -X POST https://your-domain.com/api/auth/signin \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"test123"}'
```

### 2. Test Stripe Checkout

1. Go to `/billing`
2. Click "Upgrade" on a plan
3. Complete test checkout
4. Verify tier update in database

### 3. Test AI API

```bash
curl -X POST https://your-domain.com/api/ai/run \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <token>" \
  -d '{
    "model": "gpt-4",
    "messages": [{"role": "user", "content": "Test"}]
  }'
```

### 4. Verify Edge Functions

```bash
# Test lifecycle cron
curl https://your-project.supabase.co/functions/v1/lifecycle-cron \
  -H "Authorization: Bearer <anon_key>"

# Should return churn report data
```

---

## Monitoring

### Supabase Logs

1. Go to Supabase Dashboard → Logs
2. Monitor Edge Function logs
3. Check database logs for errors

### PostHog Analytics

Monitor events in PostHog Dashboard:
- `ai_agent_request`
- `tier_upgraded`
- `ai_token_usage`
- `ai_agent_error`

### Sentry Error Tracking

Errors are automatically tracked if `SENTRY_DSN` is configured.

---

## Troubleshooting

### Build Failures

```bash
# Check build logs in Cloudflare
# Common issues:
# - Missing environment variables
# - TypeScript errors
# - Missing dependencies
```

### Edge Function Errors

```bash
# Check Supabase logs
# Test locally:
supabase functions serve stripe-checkout
```

### Database Connection Issues

```bash
# Verify RLS policies
supabase db diff

# Check connection string
# Ensure VITE_SUPABASE_URL is correct
```

---

## Rollback Procedure

### Cloudflare Pages

1. Go to Pages → Deployments
2. Select previous deployment
3. Click "Retry deployment"

### Supabase

```bash
# Rollback migration
supabase db reset

# Or manually revert via SQL
```

---

## Security Checklist

- [ ] All environment variables set
- [ ] RLS policies enabled on all tables
- [ ] Service role keys secured
- [ ] Stripe webhook secret configured
- [ ] HTTPS enabled (Cloudflare)
- [ ] CORS configured correctly
- [ ] Rate limiting enabled
- [ ] Audit logging active

---

## See Also

- [Environment Setup](/docs/how_to_start/DEPLOYMENT_GUIDE.md)
- [API Usage](./api-usage.mdx)
- [Phase Summaries](/docs/core/phase-summaries.mdx)

